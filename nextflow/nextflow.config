// Pipeline defaults and runtime profiles.

// Global default params, used in configs
params {

    bioinfo_base_dir            = '/mnt/nfs/new/bioinformatics'

    // Input options
    input                       = null
    structure_design_mode       = 'rfdiffusion' // {rfdiffusion, null}
    inverse_folding_mode        = 'proteinmpnn' // {proteinmpnn, null}
    variant_generation_mode     = 'esm' // {esm, null}
    // Canonical pipeline defaults for paper: RFdiffusion -> ProteinMPNN -> ESM-2 -> MMseqs2 -> Protenix -> Vina-GPU
    structure_prediction_mode   = 'protenix' // {colabfold, esmfold, protenix, alphafold3, null}
    docking_mode                = 'vina_gpu' // {vina_cpu, vina_gpu, diffdock, null}
    use_gpu                     = false

    // RFDiffusion parameters
    rfdiffusion_model_directory_path = "${params.bioinfo_base_dir}/rfdiffusion/models"
    rfdiffusion_num_designs          = 3
    rfdiffusion_contigs              = '[110-130]'

    // ProteinMPNN parameters
    proteinmpnn_num_seq_per_target = 3
    proteinmpnn_sampling_temp      = 0.15

    // ESM parameters
    // When null, variant_generation subworkflow derives variants from protenix sample count
    esm_num_variants = null
    esm_max_mutations = 1
    esm_top_k = 5
    esm_model_name = 'facebook/esm2_t33_650M_UR50D'
    esm_cache_dir = '/mnt/nfs/new/cache_dir'

    // AutoDock parameters
    vina_cpu_exhaustiveness      = 8
    vina_gpu_threads             = 8000   //have changed it from 8000

    // Alphafold3 parameters
    alphafold3_num_samples      = 1

    // Colabfold parameters
    colabfold_server            = "webserver"
    colabfold_model_preset      = "alphafold2_ptm" // See ColabFold docs for valid presets.
    num_recycles_colabfold      = 3
    use_amber                   = true
    colabfold_db                = null
    db_load_mode                = 0
    host_url                    = null
    use_templates               = true
    create_colabfold_index      = false

    // Colabfold links
    colabfold_db_link           = null
    uniref30_colabfold_link     = null

    // Colabfold paths
    colabfold_db_path           = "/mnt/ssd/colabfold_db"
    //colabfold_db_path           = "/mnt/nfs/new/colabfold_db"
    uniref30_colabfold_path     = null

    // Container parameters
    container_prefix            = "jwhwang" // Docker container prefix for runtime containers

    // MSA parameters
    msa_mode                    = "mmseqs2" // {mmseqs2, null}
    mmseqs2_db1                 = "uniref30_2302_db"
    mmseqs2_db3                 = "colabfold_envdb_202108_db"
    mmseqs2_batch_size          = 10
    mmseqs2_num_iterations      = 3

    // Esmfold parameters
    esmfold_db                  = "${params.bioinfo_base_dir}/esmfold/params"
    esmfold_model_preset        = "monomer"
    esmfold_num_cycles          = 4

    // Esmfold links
    esmfold_3B_v1                           = null
    esm2_t36_3B_UR50D                       = null
    esm2_t36_3B_UR50D_contact_regression    = null

    // Protenix parameters
    protenix_num_samples        = 1
    protenix_n_step             = 200
    protenix_n_cycle            = 4

    // Esmfold paths
    esmfold_params_path         = "${params.bioinfo_base_dir}/esmfold/params"

    // Process skipping options
    skip_multiqc               = false

    // MultiQC options
    multiqc_config              = null
    multiqc_title               = null
    multiqc_logo                = null

    // Boilerplate options
    outdir                       = './results'
    tracedir                     = "${params.outdir}/pipeline_info"
    publish_dir_mode             = 'copy'
    tracedir                     = "${params.outdir}/pipeline_info"

    // Config options
    // Max resource options
    // Defaults only, expecting to be overwritten
    max_cpus                    = 64

    // Defaults for esmfold
    pdb_name_type                    = 'prot_name'

    // --- Compatibility keys to silence helper warnings ---
    // nf-core schema includes num_recycles_esmfold; map to our esmfold_num_cycles
    num_recycles_esmfold             = esmfold_num_cycles
    // Do not define `mode`; nf-core schema restricts it to esmfold/alphafold3

    // Debug flags
    debug_channels                 = false

}

// Load base.config by default for all pipelines
includeConfig 'conf/base.config'

process {
    withName: 'RUN_ESM' {
        accelerator = {
            String model = (params.esm_model_name ?: 'facebook/esm2_t33_650M_UR50D').toLowerCase()
            int request
            if (model.contains('150m')) {
                request = 2
            } else if (model.contains('3b')) {
                request = 12
            } else {
                request = 4
            }
            [ request: request, limit: request, type: 'aliyun.com/gpu-mem' ]
        }
    }
}


profiles {
    debug {
        dumpHashes              = true
        process.beforeScript    = 'echo $HOSTNAME'
        cleanup                 = false
        nextflow.enable.configProcessNamesValidation = true
    }
    docker {
        docker.enabled         = true
        // Mount the repository root (parent of projectDir) to /workspace
        docker.runOptions      = "--entrypoint '' --ipc=host -v ${projectDir.getParent()}:/workspace -v /mnt/nfs/new:/mnt/nfs/new"
        if (params.use_gpu) {
            docker.runOptions  += ' --gpus all'
        } else {
            docker.runOptions  += ' -u $(id -u):$(id -g)'
        }
        conda.enabled          = false
        singularity.enabled    = false
        podman.enabled         = false
        shifter.enabled        = false
        charliecloud.enabled   = false
        apptainer.enabled      = false
    }
    test                          { includeConfig 'conf/test.config'                                   }
    test_docking                  { includeConfig 'conf/test_docking.config'                           }
    test_msa                      { includeConfig 'conf/test_msa.config'                               }
    test_structure_prediction     { includeConfig 'conf/test_structure_prediction.config'              }
    test_structure_design         { includeConfig 'conf/test_structure_design.config'                  }
    k8s {
        // Run the pipeline on a Kubernetes cluster
        k8s {
            namespace = 'nextflow'
            serviceAccount = 'nextflow'

            computeResourceType = 'Job'


            // k8s.autoMountHostPaths = true
            k8s.autoMountHostPaths = false
            debug.yaml = true
            pullPolicy = 'IfNotPresent'
            retryPolicy {
                delay = '10s'
                maxAttempts = 9999
                maxDelay = '10s'
                jitter = 0
            }
        }

        process {
            executor = 'k8s'
            //UNCOMMENT THE TWO LINES HERE FOR NO_COLLOCATION
            pod = [
                [ env: 'TORCH_EXTENSIONS_DIR', value: '/mnt/ssd/torch_extensions_cache' ],
                [ env: 'TRITON_CACHE_DIR', value: '/mnt/ssd/torch_extensions_cache' ],
                // Mount the repository root (parent of projectDir) to /workspace
                [ hostPath: "${projectDir.getParent()}", mountPath: '/workspace' ],
                [ hostPath: "${projectDir.getParent()}", mountPath: "${projectDir.getParent()}" ],
                [ hostPath: '/mnt/nfs/new', mountPath: '/mnt/nfs/new' ],
                [ hostPath: '/mnt/ssd4', mountPath: '/mnt/ssd4' ],
                [ hostPath: '/mnt/ssd', mountPath: '/mnt/ssd' ],
                [ emptyDir: [ medium: 'Memory' ], mountPath: '/dev/shm' ]
                //[annotation: 'ack.gpushare.placement', value: 'require-whole-device']


                
            ]
        }
        //UNCOMMENT THESE LINES HERE FOR NO_COLLOCATION
        //executor {
          //  queueSize = 1
        //}
    }

    // // Lightweight profiles that include external scaffold configs
    // 1shg { includeConfig "${launchDir.getParent()}/runtime/conf/pipeline/1shg.config" }
    // 1tim { includeConfig "${launchDir.getParent()}/runtime/conf/pipeline/1tim.config" }
    // 1n0r { includeConfig "${launchDir.getParent()}/runtime/conf/pipeline/1n0r.config" }
}

// Nextflow plugins
plugins {
    id 'nf-validation@1.1.3' // Validation of pipeline parameters and creation of an input channel from a sample sheet
}

// Export these variables to prevent local Python/R libraries from conflicting with those in the container
// The JULIA depot path has been adjusted to a fixed path `/usr/local/share/julia` that needs to be used for packages in the container.
// See https://apeltzer.github.io/post/03-julia-lang-nextflow/ for details on that. Once we have a common agreement on where to keep Julia packages, this is adjustable.

env {
    PYTHONNOUSERSITE = 1
    R_PROFILE_USER   = "/.Rprofile"
    R_ENVIRON_USER   = "/.Renviron"
    JULIA_DEPOT_PATH = "/usr/local/share/julia"
    TORCH_HOME       = "/mnt/nfs/new/bioinformatics/cache/torch"
    HF_HOME          = "/mnt/nfs/new/bioinformatics/cache/hf"
    TRANSFORMERS_CACHE = "/mnt/nfs/new/bioinformatics/cache/hf"
    // Ensure libraries that rely on $HOME (e.g., DGL) write to a writable path
    // HOME            = "/workspace"
}

// Capture exit codes from upstream processes when piping
process.shell = ['/bin/bash', '-euo', 'pipefail']

// Disable process selector warnings by default. Use debug profile to enable warnings.
nextflow.enable.configProcessNamesValidation = false

def trace_timestamp = new java.util.Date().format( 'yyyy-MM-dd_HH-mm-ss')
timeline {
    enabled = true
    file    = "${params.outdir}/pipeline_info/execution_timeline_${trace_timestamp}.html"
}
report {
    enabled = true
    file    = "${params.outdir}/pipeline_info/execution_report_${trace_timestamp}.html"
}
trace {
    enabled = true
    file    = "${params.outdir}/pipeline_info/execution_trace_${trace_timestamp}.txt"
}
dag {
    enabled = true
    file    = "${params.outdir}/pipeline_info/pipeline_dag_${trace_timestamp}.html"
}

manifest {
    name            = 'bioinformatics.code-cal'
    author          = 'CAL'
    description     = 'End-to-end protein design pipeline and profiling'
    mainScript      = 'main.nf'
    nextflowVersion = '!>=23.04.0'
}

// Load modules.config for DSL2 module specific options
includeConfig 'conf/modules.config'

// Load modules config for pipeline specific modes
if (params.structure_prediction_mode == 'colabfold') {
    includeConfig 'conf/modules_colabfold.config'
} else if (params.structure_prediction_mode == 'esmfold') {
    includeConfig 'conf/modules_esmfold.config'
} else if (params.structure_prediction_mode == 'protenix') {
    includeConfig 'conf/modules_protenix.config'
}

// Load MSA modules config when MSA is enabled
if (params.msa_mode == 'mmseqs2' && params.msa_mode != 'null') {
    includeConfig 'conf/modules_msa.config'
}

// Load links to DBs and parameters
includeConfig 'conf/dbs.config'
